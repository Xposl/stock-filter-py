---
description: 
globs: 
alwaysApply: false
---
# FastAPI APIæ¨¡å—åŒ–æ¶æ„è§„èŒƒ

## æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†FastAPIé¡¹ç›®ä¸­APIè·¯ç”±çš„æ¨¡å—åŒ–è®¾è®¡åŸåˆ™ï¼ŒåŸºäºInvestNote-pyé¡¹ç›®çš„å®é™…ç»éªŒï¼Œé‡ç‚¹å…³æ³¨è·¯ç”±èŒè´£åˆ†ç¦»ã€ç»Ÿä¸€å®šæ—¶ä»»åŠ¡ç®¡ç†å’Œå‘åå…¼å®¹æ€§ä¿è¯ã€‚

## è·¯ç”±æ¨¡å—åŒ–åŸåˆ™

### 1. **èŒè´£åˆ†ç¦»åŸåˆ™** ğŸ”¥ æ ¸å¿ƒ

#### ä¸šåŠ¡åŠŸèƒ½è·¯ç”± vs ç³»ç»Ÿç®¡ç†è·¯ç”±
```python
# âœ… æ­£ç¡®ï¼šä¸šåŠ¡åŠŸèƒ½è·¯ç”± (ticker.py)
@router.post("/pages")           # è‚¡ç¥¨åˆ—è¡¨æŸ¥è¯¢
@router.get("/ticker/{market}/{code}")  # è‚¡ç¥¨è¯¦æƒ…æŸ¥çœ‹

# âœ… æ­£ç¡®ï¼šç³»ç»Ÿç®¡ç†è·¯ç”± (scheduler.py)  
@router.post("/cron/ticker/{market}/update")  # å®šæ—¶ä»»åŠ¡
@router.post("/cron/news")                    # å®šæ—¶ä»»åŠ¡
@router.get("/cron/news/status")              # ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢
```

#### èŒè´£è¾¹ç•Œæ¸…æ™°å®šä¹‰
- **æ•°æ®æŸ¥è¯¢è·¯ç”±**: ä¸“æ³¨ç”¨æˆ·æ•°æ®è·å–å’Œå±•ç¤º
- **å®šæ—¶ä»»åŠ¡è·¯ç”±**: ä¸“æ³¨åå°è°ƒåº¦å’Œæ‰¹é‡å¤„ç†
- **ç®¡ç†åŠŸèƒ½è·¯ç”±**: ä¸“æ³¨ç³»ç»Ÿé…ç½®å’Œç›‘æ§

### 2. **ç»Ÿä¸€å®šæ—¶ä»»åŠ¡ç®¡ç†** ğŸ”„ æœ€æ–°å®è·µ

#### é›†ä¸­å¼è°ƒåº¦ç®¡ç† (`scheduler.py`)
```python
# æ‰€æœ‰å®šæ—¶ä»»åŠ¡ç»Ÿä¸€ç®¡ç†
@router.post("/cron/ticker/{market}/update")    # è‚¡ç¥¨æ•°æ®æ›´æ–°
@router.post("/cron/news")                      # æ–°é—»æŠ“å–
@router.post("/cron/news/scheduler/start")      # è°ƒåº¦å™¨å¯åŠ¨
@router.post("/cron/news/scheduler/stop")       # è°ƒåº¦å™¨åœæ­¢
@router.get("/cron/news/status")                # çŠ¶æ€æŸ¥è¯¢
```

#### ä¼˜åŠ¿åˆ†æ
- **ç»Ÿä¸€ç›‘æ§**: æ‰€æœ‰å®šæ—¶ä»»åŠ¡çŠ¶æ€é›†ä¸­æŸ¥çœ‹
- **é…ç½®ç®¡ç†**: crontabæ–‡ä»¶ç»Ÿä¸€ç®¡ç†å®šæ—¶è§„åˆ™
- **è¿ç»´å‹å¥½**: å‡å°‘è¿ç»´äººå‘˜è®°å¿†è´Ÿæ‹…
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•

### 3. **è·¯ç”±è¿ç§»æœ€ä½³å®è·µ** â­ é‡è¦

#### è¿ç§»æ­¥éª¤
1. **ç›®æ ‡æ¨¡å—æ·»åŠ è·¯ç”±**: åœ¨scheduler.pyä¸­æ·»åŠ å®Œæ•´åŠŸèƒ½
2. **æºæ¨¡å—æ¸…ç†è·¯ç”±**: ä»ticker.pyä¸­ç§»é™¤è¿ç§»çš„è·¯ç”±
3. **ä¾èµ–æ¸…ç†**: ç§»é™¤ä¸å†éœ€è¦çš„å¯¼å…¥å’Œä¾èµ–
4. **æ–‡æ¡£æ›´æ–°**: æ›´æ–°APIæ–‡æ¡£å’Œé¡¹ç›®ç»“æ„è¯´æ˜
5. **æµ‹è¯•éªŒè¯**: ç¡®ä¿è¿ç§»ååŠŸèƒ½æ­£å¸¸

#### å‘åå…¼å®¹ä¿è¯
```python
# âœ… ä¿æŒAPIç«¯ç‚¹è·¯å¾„ä¸å˜
# è¿ç§»å‰: ticker.py
@router.post("/cron/ticker/{market}/update")

# è¿ç§»å: scheduler.py  
@router.post("/cron/ticker/{market}/update")  # è·¯å¾„ä¿æŒä¸€è‡´
```

## æ¨¡å—ç»“æ„

### ä¸»åº”ç”¨ç¨‹åº
- **[api.py](mdc:api/api.py)**: FastAPIåº”ç”¨å®ä¾‹ï¼ŒåŸºç¡€è·¯ç”±ï¼Œä¸­é—´ä»¶ï¼Œè·¯ç”±æ¨¡å—æ³¨å†Œ

### è·¯ç”±æ¨¡å— ğŸ”„ å·²æ›´æ–°
- **[routers/ticker.py](mdc:api/routers/ticker.py)**: è‚¡ç¥¨æ•°æ®æŸ¥è¯¢APIï¼ˆåˆ†é¡µã€è¯¦æƒ…ï¼‰
- **[routers/news.py](mdc:api/routers/news.py)**: æ–°é—»èšåˆAPIï¼ˆæ–‡ç« æŸ¥è¯¢ã€æºç®¡ç†ï¼‰
- **[routers/scheduler.py](mdc:api/routers/scheduler.py)**: ç»Ÿä¸€å®šæ—¶ä»»åŠ¡APIï¼ˆè‚¡ç¥¨æ›´æ–°ã€æ–°é—»æŠ“å–ã€è°ƒåº¦ç®¡ç†ï¼‰

### å…±äº«æ¨¡å‹
- **[models.py](mdc:api/models.py)**: APIè¯·æ±‚/å“åº”çš„Pydanticæ¨¡å‹å®šä¹‰

## éƒ¨ç½²å’Œè¿ç»´é›†æˆ

### 1. **è‡ªåŠ¨åŒ–éƒ¨ç½²** (`deploy.sh`) ğŸ”„ å·²æ›´æ–°

#### crontabè‡ªåŠ¨æ›´æ–°ç­–ç•¥
```bash
# 1. å¤‡ä»½å½“å‰crontab
crontab -l > /tmp/crontab_backup_$(date +%Y%m%d_%H%M%S) 2>/dev/null || true

# 2. åˆ é™¤æ—§çš„ç›¸å…³ä»»åŠ¡
crontab -l 2>/dev/null | grep -v "investnote" | crontab - 2>/dev/null || true

# 3. å®‰è£…æ–°çš„crontab
crontab scripts/crontab

# 4. éªŒè¯å®‰è£…ç»“æœ
crontab -l | grep -E "(ticker|news|investnote)" || echo "æœªæ‰¾åˆ°ç›¸å…³ä»»åŠ¡"
```

#### éƒ¨ç½²å®Œæ•´æ€§æ£€æŸ¥
```bash
# å®¹å™¨çŠ¶æ€æ£€æŸ¥
docker ps | grep -q "investnote"

# APIå¥åº·æ£€æŸ¥  
curl -s http://localhost:8000/health | jq -r .status

# å®šæ—¶ä»»åŠ¡éªŒè¯
crontab -l | grep -E "(ticker|news)"
```

### 2. **ç»Ÿä¸€crontabé…ç½®** (`scripts/crontab`) ğŸ”„ å·²æ›´æ–°

#### ä»»åŠ¡åˆ†ç±»å’Œæ³¨é‡Š
```bash
# ===== è‚¡ç¥¨æ•°æ®æ›´æ–°ä»»åŠ¡ =====
# ç¾è‚¡ï¼šæ¯å‘¨äºŒåˆ°å‘¨å…­æ—©ä¸Š6ç‚¹ (åŒ—äº¬æ—¶é—´å¯¹åº”ç¾è‚¡æ”¶ç›˜å)
0 6 * * 2-6 curl -X POST http://localhost:8000/investnote/cron/ticker/us/update

# ===== æ–°é—»æŠ“å–ä»»åŠ¡ =====  
# æ–°é—»æŠ“å–ï¼šæ¯å¤©æ—©ä¸Š6ç‚¹ã€ä¸­åˆ12ç‚¹ã€ä¸‹åˆ6ç‚¹ã€æ™šä¸Š10ç‚¹ (4æ¬¡/å¤©)
0 6,12,18,22 * * * curl -X POST http://localhost:8000/investnote/cron/news
```

#### æœ€ä½³å®è·µ
- **æ—¶åŒºè®¾ç½®**: æ˜ç¡®è®¾ç½®TZ='Asia/Shanghai'
- **ä»»åŠ¡åˆ†ç»„**: ç”¨æ³¨é‡Šåˆ†éš”ä¸åŒç±»å‹çš„ä»»åŠ¡
- **é¢‘ç‡è¯´æ˜**: æ³¨é‡Šä¸­è¯´æ˜æ‰§è¡Œé¢‘ç‡çš„ä¸šåŠ¡é€»è¾‘
- **é”™è¯¯å®¹é”™**: curlå‘½ä»¤å¢åŠ è¶…æ—¶å’Œé‡è¯•å‚æ•°

## è·¯ç”±æ¨¡å—è§„èŒƒ

### APIRouteré…ç½®
```python
from fastapi import APIRouter

# åˆ›å»ºè·¯ç”±å™¨ï¼Œè®¾ç½®æ ‡ç­¾ç”¨äºæ–‡æ¡£åˆ†ç»„
router = APIRouter(tags=["æ¨¡å—åç§°"])
```

### è·¯ç”±å®šä¹‰æ¨¡å¼
```python
@router.{http_method}("/endpoint_path")
async def endpoint_function(
    # è·¯å¾„å‚æ•°
    path_param: str,
    # æŸ¥è¯¢å‚æ•°
    query_param: Optional[str] = None,
    # è¯·æ±‚ä½“
    request: RequestModel = None,
    # ä¾èµ–æ³¨å…¥
    current_user: Dict = Depends(auth_required())
):
    """ç«¯ç‚¹æè¿°ï¼Œç”¨äºè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£"""
    try:
        # ä¸šåŠ¡é€»è¾‘å¤„ç†
        return {"status": "success", "data": result}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

## æ¨¡å—ä¾èµ–åŸåˆ™

### å¯¼å…¥å±‚æ¬¡
- **è·¯ç”±æ¨¡å—** â†’ **Handlerå±‚** â†’ **Repositoryå±‚**
- **è·¯ç”±æ¨¡å—** â†’ **å…±äº«æ¨¡å‹** â†’ **PydanticéªŒè¯**
- **ä¸»åº”ç”¨** â†’ **è·¯ç”±æ¨¡å—** â†’ **ä¸­é—´ä»¶å¤„ç†**

### ç¦æ­¢ä¾èµ–
- è·¯ç”±æ¨¡å—é—´ä¸èƒ½ç›¸äº’å¯¼å…¥
- è·¯ç”±æ¨¡å—ä¸èƒ½ç›´æ¥è°ƒç”¨Repository
- è·¯ç”±æ¨¡å—ä¸èƒ½åŒ…å«ä¸šåŠ¡é€»è¾‘ä»£ç 

## å‘åå…¼å®¹ä¿è¯

### APIè·¯å¾„ä¿æŒ
- æ‹†åˆ†å‰: `/pages` â†’ æ‹†åˆ†å: `/pages` (è·¯å¾„ä¸å˜)
- æ‹†åˆ†å‰: `/news/sources` â†’ æ‹†åˆ†å: `/news/sources` (è·¯å¾„ä¸å˜)
- è¿ç§»å‰: ticker.pyä¸­`/cron/ticker/{market}/update` â†’ è¿ç§»å: scheduler.pyä¸­ç›¸åŒè·¯å¾„

### è¯·æ±‚/å“åº”æ ¼å¼
- æ‰€æœ‰APIçš„è¯·æ±‚å‚æ•°æ ¼å¼ä¿æŒä¸å˜
- æ‰€æœ‰APIçš„å“åº”æ•°æ®ç»“æ„ä¿æŒä¸å˜
- HTTPçŠ¶æ€ç å’Œé”™è¯¯å“åº”æ ¼å¼ä¿æŒä¸å˜

## æ¶æ„å‘å±•æ–¹å‘

### 1. **å¾®æœåŠ¡å‡†å¤‡**

#### è·¯ç”±æ¨¡å—ç‹¬ç«‹åŒ–
```python
# æœªæ¥å¯ç‹¬ç«‹ä¸ºå¾®æœåŠ¡
ticker_service = {
    "routes": ["/pages", "/ticker/{market}/{code}"],
    "dependencies": ["TickerRepository", "DataSourceHelper"]
}

scheduler_service = {
    "routes": ["/cron/*"],
    "dependencies": ["å„ç§Repository", "BackgroundTasks"]
}
```

### 2. **APIç½‘å…³é›†æˆ**

#### è·¯ç”±æ³¨å†Œä¸­å¿ƒåŒ–
```python
# api/api.py ä½œä¸ºè·¯ç”±æ³¨å†Œä¸­å¿ƒ
app.include_router(ticker.router, prefix="/investnote", tags=["è‚¡ç¥¨"])
app.include_router(scheduler.router, prefix="/investnote", tags=["å®šæ—¶ä»»åŠ¡"])
app.include_router(news.router, prefix="/investnote", tags=["æ–°é—»"])
```

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°ç«¯ç‚¹
1. ç¡®å®šåŠŸèƒ½æ¨¡å—å½’å± (ticker/news/scheduler)
2. åœ¨å¯¹åº”è·¯ç”±æ–‡ä»¶ä¸­æ·»åŠ ç«¯ç‚¹
3. ä½¿ç”¨ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æ¨¡å¼
4. æ·»åŠ é€‚å½“çš„ç±»å‹æç¤ºå’Œæ–‡æ¡£å­—ç¬¦ä¸²

### è·¯ç”±è¿ç§»æŒ‡å— ğŸ†•
1. **åˆ†æè¿ç§»å¿…è¦æ€§**: è¯„ä¼°è·¯ç”±èŒè´£æ˜¯å¦ç¬¦åˆæ¨¡å—å®šä½
2. **å‡†å¤‡ç›®æ ‡æ¨¡å—**: åœ¨ç›®æ ‡æ¨¡å—ä¸­å®ç°å®Œæ•´åŠŸèƒ½
3. **æµ‹è¯•æ–°å®ç°**: ç¡®ä¿è¿ç§»ååŠŸèƒ½å®Œæ•´æ€§
4. **æ¸…ç†æºæ¨¡å—**: ç§»é™¤åŸè·¯ç”±å’Œä¸éœ€è¦çš„ä¾èµ–
5. **æ›´æ–°æ–‡æ¡£**: åŒæ­¥æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œé…ç½®

### åˆ›å»ºæ–°æ¨¡å—
1. åœ¨`api/routers/`ä¸‹åˆ›å»ºæ–°çš„è·¯ç”±æ–‡ä»¶
2. å®šä¹‰APIRouterå®ä¾‹
3. åœ¨ä¸»åº”ç”¨ä¸­æ³¨å†Œè·¯ç”±æ¨¡å—
4. æ›´æ–°APIæ–‡æ¡£æ ‡ç­¾åˆ†ç»„

## è§„èŒƒæ£€æŸ¥æ¸…å•

### è·¯ç”±è®¾è®¡æ£€æŸ¥
- [ ] æ¯ä¸ªè·¯ç”±æ¨¡å—èŒè´£å•ä¸€æ¸…æ™°
- [ ] å®šæ—¶ä»»åŠ¡é›†ä¸­åœ¨scheduler.pyç®¡ç†
- [ ] APIç«¯ç‚¹è·¯å¾„ç¬¦åˆRESTfulè§„èŒƒ
- [ ] å‘åå…¼å®¹æ€§å¾—åˆ°ä¿è¯

### éƒ¨ç½²é›†æˆæ£€æŸ¥
- [ ] deploy.shåŒ…å«crontabè‡ªåŠ¨æ›´æ–°é€»è¾‘
- [ ] scripts/crontabæ–‡ä»¶ç»“æ„æ¸…æ™°æœ‰æ³¨é‡Š
- [ ] å®¹å™¨å¯åŠ¨å’Œå¥åº·æ£€æŸ¥å®Œæ•´
- [ ] é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶å®Œå–„

### æ–‡æ¡£ç»´æŠ¤æ£€æŸ¥
- [ ] é¡¹ç›®ç»“æ„æ–‡æ¡£åŠæ—¶æ›´æ–°
- [ ] APIæ–‡æ¡£åæ˜ æœ€æ–°è·¯ç”±åˆ†å¸ƒ
- [ ] éƒ¨ç½²è¯´æ˜åŒ…å«æ–°çš„éƒ¨ç½²æµç¨‹
- [ ] Memory Bankè®°å½•æ¶æ„å˜æ›´

### æµ‹è¯•éªŒè¯æ¸…å•
- [ ] ç¡®ä¿æ‰€æœ‰ç°æœ‰APIç«¯ç‚¹åŠŸèƒ½æ­£å¸¸
- [ ] éªŒè¯APIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆæ­£ç¡®
- [ ] æ£€æŸ¥è·¯ç”±æ¨¡å—é—´æ— å¾ªç¯ä¾èµ–
- [ ] æµ‹è¯•è®¤è¯ä¸­é—´ä»¶æ­£å¸¸å·¥ä½œ
- [ ] éªŒè¯crontabä»»åŠ¡æ­£ç¡®é…ç½®
- [ ] æµ‹è¯•éƒ¨ç½²è„šæœ¬å®Œæ•´æ‰§è¡Œ

è¿™ç§æ¨¡å—åŒ–æ¶æ„ç¡®ä¿äº†FastAPIé¡¹ç›®çš„å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œè¿ç»´å‹å¥½æ€§ï¼Œä¸ºåç»­çš„å¾®æœåŠ¡æ¶æ„æ¼”è¿›å¥ å®šäº†åŸºç¡€ã€‚

# InvestNote-py 活跃上下文 (2025.06.01 更新)

## 当前开发状态

### 项目阶段
- **阶段**: AI分析模块集成阶段
- **版本**: Alpha 0.6.0 (AI分析系统MVP)
- **重点**: PocketFlow AI工作流开发和千问LLM集成

### 最新更新 (2025.06.01)
- ✅ **PocketFlow框架集成完成**: v0.0.2已成功安装和配置
- ✅ **AI分析模块目录结构创建**: core/ai_agents/目录体系建立
- ✅ **Cursor规则系统更新**: AI分析架构文档完善
- ✅ **数据提供者层**: AKShare优先、雪球补充的多源数据访问
- ✅ **雪球抽象层重构**: 统一客户端管理，消除代码重复
- 🔄 **千问LLM客户端开发中**: OpenAI兼容接口适配
- 🔄 **ChromaDB向量存储配置**: 嵌入式部署和语义分析
- 🔄 **PocketFlow工作流定义**: 新闻分析流水线开发

### 当前Sprint目标 (2025.06.01 - 2025.06.08)
1. **千问LLM客户端实现**: 完成OpenAI兼容接口适配
2. **ChromaDB集成**: 向量存储和相似性检索
3. **基础工作流开发**: 新闻分析PocketFlow流程
4. **Token优化策略**: 成本控制和性能优化

## 技术栈现状 (更新)

### 🆕 新集成的AI技术栈
1. **PocketFlow 0.0.2** (已集成)
   - 100行LLM工作流框架
   - GitHub: 5.2k星，活跃社区
   - 专为AI Agent构建

2. **千问LLM服务** (集成中)
   - 阿里云大语言模型
   - 成本优势: ~0.01元/千token
   - OpenAI兼容接口

3. **硅基流动API** (备用方案)
   - OpenAI兼容端点
   - 降级备用LLM服务

4. **ChromaDB** (配置中)
   - 嵌入式向量数据库
   - 单机部署，资源友好
   - 语义相似性检索

### 已稳定运行的基础设施
1. **FastAPI应用框架** (生产就绪)
   - 三层架构：API-Handler-Repository
   - 模块化路由系统
   - Pydantic数据验证

2. **多源股票数据集成** (已完成)
   - AKShare: 优先级100，主要数据源
   - 雪球API: 优先级50，补充数据源
   - 智能降级和错误处理

3. **新闻聚合系统** (已完成)
   - RSS源: feedparser解析
   - 雪球时间线: 重构后的抽象层
   - 统一新闻源管理

4. **认证和安全** (已完成)
   - gRPC认证服务集成
   - JWT令牌验证
   - Bearer Token中间件

## 当前技术重点和挑战

### 1. AI工作流开发 🎯
**目标**: 实现基于PocketFlow的四层新闻分析流水线

**当前进展**:
- ✅ 框架集成和目录结构
- 🔄 千问LLM客户端开发 (30%)
- ⏳ 工作流节点定义 (0%)
- ⏳ 流程编排和测试 (0%)

**技术挑战**:
- 千问API适配OpenAI接口格式
- Token使用量优化和成本控制
- 异步工作流执行和错误处理

### 2. 向量语义分析 🎯
**目标**: ChromaDB嵌入式部署和新闻相似性分析

**当前进展**:
- ⏳ ChromaDB配置和初始化 (0%)
- ⏳ 文本向量化流程 (0%)
- ⏳ 相似性检索API (0%)

**技术挑战**:
- 向量数据库Schema设计
- 文本嵌入模型选择和优化
- 检索性能和存储效率

### 3. 系统集成优化 🔄
**目标**: AI分析结果与现有系统无缝集成

**当前进展**:
- ✅ 数据库字段设计 (news_articles表扩展)
- 🔄 Handler层集成点设计 (50%)
- ⏳ API端点开发 (0%)

**技术挑战**:
- 异步AI分析和同步API响应
- 分析结果缓存和实时更新
- 错误处理和降级策略

## 代码结构现状 (2025.06.01)

### 核心模块完成度
```
core/
├── models/          ✅ Pydantic模型体系完善
├── service/         ✅ Repository层数据访问完成
├── handler/         ✅ 业务逻辑处理层完成
├── data_providers/  ✅ 多源数据提供者完成
├── utils/xueqiu/    ✅ 雪球抽象层重构完成
├── news_aggregator/ ✅ 新闻聚合系统完成
├── ai_agents/       🔄 AI代理框架 (30%完成)
│   ├── flow_definitions/    ⏳ PocketFlow工作流定义
│   ├── llm_clients/        🔄 千问+硅基流动客户端 (30%)
│   ├── vector_store/       ⏳ ChromaDB向量存储
│   ├── analyzers/          ⏳ 分析器组件
│   └── utils/              ⏳ AI工具类
├── auth/            ✅ 认证系统完成
├── database/        ✅ 数据库操作完成
└── scheduler/       ✅ 定时任务系统完成
```

### API模块完成度
```
api/
├── api.py           ✅ 主路由配置完成
├── models.py        ✅ 请求响应模型完成
└── routers/         ✅ 模块化路由完成
    ├── ticker.py    ✅ 股票相关API完成
    ├── news.py      ✅ 新闻管理API完成
    └── scheduler.py ✅ 调度管理API完成
```

## 当前开发优先级 (2025.06.01 - 2025.06.22)

### 🔥 超高优先级 (本周完成)
1. **千问LLM客户端实现**
   - OpenAI兼容接口适配
   - 异步调用和错误处理
   - Token计算和成本监控

2. **ChromaDB基础配置**
   - 数据库初始化和Schema设计
   - 基础向量操作API
   - 文本嵌入流程

### 🔥 高优先级 (第2周完成)
1. **PocketFlow工作流开发**
   - 四层分析流水线定义
   - 节点逻辑实现和测试
   - 工作流编排和执行

2. **AI分析Handler集成**
   - NewsAnalysisHandler开发
   - 异步任务集成
   - 结果存储和缓存

### 🟡 中优先级 (第3周完成)
1. **AI分析API端点**
   - 分析触发和状态查询
   - 结果检索和格式化
   - 性能监控和日志

2. **定时任务集成**
   - 批量新闻分析调度
   - 错误重试和监控
   - 资源使用优化

### 🟢 低优先级 (后续版本)
1. **Multi-Agent协作**
2. **MCP协议集成**
3. **高级投资策略**

## 技术债务和风险管理

### 当前技术债务
1. **测试覆盖率不足**
   - AI分析模块缺乏单元测试
   - 集成测试用例不完整
   - 性能测试基准缺失

2. **错误处理待完善**
   - LLM调用失败的降级策略
   - 向量数据库异常处理
   - 工作流执行错误恢复

3. **监控和日志待加强**
   - AI分析性能指标收集
   - Token使用量监控
   - 成本分析和报告

### 主要风险和缓解措施
1. **LLM服务可用性风险**
   - 缓解: 千问+硅基流动双备份
   - 监控: 实时可用性检测
   - 降级: 规则引擎备用方案

2. **成本控制风险**
   - 缓解: Token预算和限流
   - 监控: 实时成本跟踪
   - 控制: 智能批处理优化

3. **性能瓶颈风险**
   - 缓解: 异步处理和缓存
   - 监控: 响应时间和资源使用
   - 优化: 批量处理和预计算

## 下一步具体计划

### 本周目标 (2025.06.01 - 2025.06.08)
**Day 1-2**: 千问LLM客户端基础实现
- OpenAI兼容接口封装
- 异步调用和连接池管理
- 基础单元测试

**Day 3-4**: ChromaDB集成基础
- 数据库初始化和配置
- 基础向量操作API
- 文本嵌入流程

**Day 5-7**: PocketFlow工作流框架
- 工作流节点定义
- 基础流程编排
- 集成测试环境

### 第2周目标 (2025.06.08 - 2025.06.15)
- PocketFlow四层分析流水线实现
- NewsAnalysisHandler核心逻辑
- 异步任务队列集成

### 第3周目标 (2025.06.15 - 2025.06.22)
- AI分析API端点开发
- 定时任务调度集成
- 系统测试和性能优化

## 成功指标

### 技术指标
- **单条新闻分析时间**: <5秒
- **并发处理能力**: 10条新闻同时分析
- **Token使用效率**: <0.01元/条新闻
- **分析准确率**: 情感分析准确率>85%

### 业务指标
- **新闻处理覆盖率**: >90%新闻源文章
- **投资洞察质量**: 可操作建议比例>60%
- **系统稳定性**: 99%+可用性
- **用户体验**: API响应时间<200ms

### 资源指标
- **内存使用**: AI模块增量<100MB
- **存储需求**: 向量数据库<1GB/月
- **网络流量**: LLM调用优化90%
- **成本控制**: 月度AI成本<100元 